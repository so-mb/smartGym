name: Build smartGym Access Database

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-access-db:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        pip install pyodbc pywin32

    - name: Check if Access Database Engine is installed
      id: check_driver
      run: |
        $drivers = Get-OdbcDriver | Where-Object { $_.Name -like "*Access*" }
        if ($drivers) {
          Write-Host "Access Database Engine driver found: $($drivers.Name -join ', ')"
          Write-Host "driver_installed=true" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "Access Database Engine driver not found, will install"
          Write-Host "driver_installed=false" >> $env:GITHUB_OUTPUT
        }

    - name: Install Microsoft Access Database Engine
      if: steps.check_driver.outputs.driver_installed == 'false'
      run: |
        $ErrorActionPreference = "Stop"
        Write-Host "Downloading Access Database Engine..."
        
        # Try multiple known working URLs (Microsoft changes these periodically)
        $urls = @(
          "https://download.microsoft.com/download/3/5/C/35C84A0E-DC6E-4EBC-AE0B-1D3B78B99A4A/accessdatabaseengine_X64.exe",
          "https://download.microsoft.com/download/3/5/C/35C84A0E-DC6E-4EBC-AE0B-1D3B78B99A4A/AccessDatabaseEngine_X64.exe"
        )
        
        $downloaded = $false
        foreach ($url in $urls) {
          try {
            Write-Host "Trying URL: $url"
            Invoke-WebRequest -Uri $url -OutFile AccessDatabaseEngine.exe -ErrorAction Stop
            Write-Host "Download successful from: $url"
            $downloaded = $true
            break
          } catch {
            Write-Host "Failed: $_"
            continue
          }
        }
        
        if (-not $downloaded) {
          Write-Host "Direct downloads failed, trying to parse Microsoft download page..."
          $pageUrl = "https://www.microsoft.com/en-us/download/details.aspx?id=54920"
          try {
            $response = Invoke-WebRequest -Uri $pageUrl -UseBasicParsing
            # Look for download links in the page
            $matches = [regex]::Matches($response.Content, 'href="([^"]*[Aa]ccess[Dd]atabase[Ee]ngine[^"]*\.exe[^"]*)"')
            if ($matches.Count -gt 0) {
              $downloadLink = $matches[0].Groups[1].Value
              if (-not $downloadLink.StartsWith("http")) {
                $downloadLink = "https://www.microsoft.com" + $downloadLink
              }
              Write-Host "Found download link: $downloadLink"
              Invoke-WebRequest -Uri $downloadLink -OutFile AccessDatabaseEngine.exe -ErrorAction Stop
              $downloaded = $true
            }
          } catch {
            Write-Host "Failed to parse download page: $_"
          }
        }
        
        if (-not $downloaded) {
          throw "Could not download Access Database Engine from any source"
        }
        
        Write-Host "Installing Access Database Engine (this may take a minute)..."
        $process = Start-Process -FilePath .\AccessDatabaseEngine.exe -ArgumentList "/quiet" -Wait -PassThru
        # Exit code 3010 means success but reboot required (common for drivers)
        if ($process.ExitCode -ne 0 -and $process.ExitCode -ne 3010) {
          Write-Warning "Installation exit code: $($process.ExitCode) (3010 is OK for reboot required)"
        } else {
          Write-Host "Installation completed successfully"
        }

    - name: Build Access database
      run: |
        python build.py
      working-directory: .

    - name: Verify database file exists
      run: |
        if (-not (Test-Path "smart_gym.accdb")) {
          Write-Error "Database file was not created!"
          exit 1
        }
        Write-Host "Database file created successfully: $(Get-Item smart_gym.accdb | Select-Object -ExpandProperty Length) bytes"

    - name: Upload Access database artifact
      uses: actions/upload-artifact@v4
      with:
        name: smart-gym-access-db
        path: smart_gym.accdb
