name: Build smartGym Access Database

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-access-db:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        architecture: 'x86'

    - name: Install Python dependencies
      run: |
        pip install pyodbc pywin32 msaccessdb

    - name: Check if Access ODBC driver is available
      id: check_driver
      run: |
        $ErrorActionPreference = "Stop"
        $drivers = python -c "import pyodbc; print('\n'.join(pyodbc.drivers()))"
        Write-Host "pyodbc.drivers():"
        if ($drivers) {
          ($drivers -split "`r?`n") | Where-Object { $_ -and $_.Trim() -ne "" } | ForEach-Object { Write-Host " - $_" }
        } else {
          Write-Host " - (none)"
        }
        $hasMdb = $false
        if ($drivers) { $hasMdb = $drivers.ToLower().Contains("*.mdb") -or $drivers.ToLower().Contains("access") }
        if ($hasMdb) {
          Write-Host "Found an Access ODBC driver (sufficient for .mdb build)."
        } else {
          throw "No Access ODBC driver detected by pyodbc. This runner cannot build even .mdb via ODBC."
        }

    - name: Debug ODBC drivers (registry)
      run: |
        $ErrorActionPreference = "Continue"
        Write-Host "=== 64-bit ODBC Drivers ==="
        reg query "HKLM\SOFTWARE\ODBC\ODBCINST.INI\ODBC Drivers" /s
        Write-Host "=== 32-bit ODBC Drivers (WOW6432Node) ==="
        reg query "HKLM\SOFTWARE\WOW6432Node\ODBC\ODBCINST.INI\ODBC Drivers" /s

    # NOTE: Microsoft Access Database Engine 2016 download is deprecated/removed.
    # We generate a .mdb with 32-bit Python, matching the built-in 32-bit Access ODBC drivers on runners.

    - name: Build Access database
      run: |
        python build.py
      working-directory: .

    - name: Verify database file exists
      run: |
        if (-not (Test-Path "smart_gym.mdb")) {
          Write-Error "Database file was not created!"
          exit 1
        }
        Write-Host "Database file created successfully: $(Get-Item smart_gym.mdb | Select-Object -ExpandProperty Length) bytes"

    - name: Upload Access database artifact
      uses: actions/upload-artifact@v4
      with:
        name: smart-gym-access-db
        path: smart_gym.mdb
